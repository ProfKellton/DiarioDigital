<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diário Digital</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #ff00ff 0%, #8000ff 100%);
            --main-content-blur: none;
            /* Control blur for main content */
            --main-content-pointer-events: auto;
            /* Control pointer events for main content */
            --main-content-user-select: auto;
            /* Control user select for main content */
            --note-indicator-color: #6dff6d;
            /* Default green for note indicator */
            --filtered-day-border: 2px solid #ffeb3b;
            /* Border for filtered days */
        }

        body {
            margin: 0;
            font-family: sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-x: hidden;
            /* Prevent horizontal scroll when sidebar opens */
            transition: background 0.5s ease-in-out;
            /* Smooth transition for background color change */
        }

        /* Animation for floating effect */
        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-5px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 50;
            flex-wrap: wrap;
            /* Allow items to wrap on smaller screens */
            gap: 15px;
            /* Space between header items */
        }

        .header-left {
            display: flex;
            align-items: center;
            flex-direction: column;
            /* Changed to column to stack title and username */
            align-items: flex-start;
            /* Align text to the left */
        }

        .header-left img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
            align-self: flex-start;
            /* Ensure logo stays at the start */
        }

        .header-title-container {
            display: flex;
            align-items: center;
            width: 100%;
            /* Take full width for alignment */
        }

        .gradient-text {
            background: linear-gradient(135deg, #f472b6, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            font-size: 2em;
            font-weight: bold;
            margin: 0;
            /* Remove default margin */
        }

        #usernameDisplay {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
            /* Space between title and username */
            margin-left: 60px;
            /* Align with the start of the title, considering logo width */
        }

        /* Menu button styles */
        #menuButton {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        #menuButton:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Sidebar styles */
        #sidebar {
            height: 100%;
            width: 0;
            /* Hidden by default */
            position: fixed;
            z-index: 1001;
            /* Above modal overlay to allow closing */
            top: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.9);
            /* Semi-transparent black */
            overflow-x: hidden;
            transition: 0.5s;
            /* Smooth transition for opening/closing */
            padding-top: 60px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
        }

        #sidebar.open {
            width: 280px;
            /* Default width when open for desktop */
            padding-left: 20px;
            padding-right: 20px;
        }

        #closeSidebar {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 40px;
            color: white;
            cursor: pointer;
            text-decoration: none;
        }

        #sidebar h2 {
            margin-bottom: 25px;
            color: #f472b6;
            font-size: 1.8em;
        }

        /* Acordeão para opções da sidebar */
        .sidebar-section {
            width: 100%;
            margin-bottom: 15px;
            /* Space between sections */
        }

        .sidebar-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            transition: border-bottom 0.3s ease;
            margin-bottom: 0;
            /* Reset margin */
        }

        .sidebar-section-header:hover {
            border-bottom-color: rgba(255, 255, 255, 0.5);
        }

        .sidebar-section-header h3 {
            margin: 0;
            color: #a78bfa;
            /* Lighter purple for section titles */
            font-size: 1.1em;
            /* Slightly smaller font */
        }

        .sidebar-section-header .arrow-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .sidebar-section-header.active .arrow-icon {
            transform: rotate(90deg);
        }

        .sidebar-section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.4s ease-out;
            opacity: 0;
            /* Start hidden with opacity */
            padding-top: 0;
            /* No padding when collapsed */
        }

        .sidebar-section-content.active {
            max-height: 300px;
            /* Adjust as needed for content height */
            /* Use a value large enough to cover content */
            opacity: 1;
            padding-top: 15px;
            /* Add padding when open */
        }


        .sidebar-section-content button,
        .sidebar-section-content select {
            background: linear-gradient(135deg, #f472b6, #a78bfa);
            /* Default gradient for buttons */
            border: none;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            width: 100%;
            /* Make buttons full width */
            margin-bottom: 10px;
            /* Space between buttons in the same section */
        }

        /* NEW: Styles for selected print button */
        .sidebar-section-content button.selected-print-option {
            border: 2px solid #ffeb3b;
            box-shadow: 0 0 15px rgba(255, 235, 59, 0.7);
        }


        .sidebar-section-content button:last-child {
            margin-bottom: 0;
            /* No margin for the last button */
        }

        .sidebar-section-content button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        /* Styles for the color theme buttons' ::before (the little circle) */
        #colorOptionsContent button::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            /* Prevent shrinking */
        }

        /* Specific styles for color options inside content - the actual color of the circle */
        #colorOptionsContent button[data-color*="ff00ff"]::before {
            background: linear-gradient(135deg, #ff00ff, #8000ff);
        }

        #colorOptionsContent button[data-color*="00c6ff"]::before {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
        }

        #colorOptionsContent button[data-color*="00ff00"]::before {
            background: linear-gradient(135deg, #00ff00, #008000);
        }

        #colorOptionsContent button[data-color*="ffcc00"]::before {
            background: linear-gradient(135deg, #ffcc00, #ff6600);
        }

        #colorOptionsContent button[data-color*="A020F0"]::before {
            background: linear-gradient(135deg, #A020F0, #5C2B6A);
        }

        #colorOptionsContent button[data-color*="000000"]::before {
            background: linear-gradient(135deg, #000000, #333333);
        }

        /* NEW: Bolinha para a cor do tema selecionado */
        #colorOptionsContent button.selected-theme::before {
            border: 3px solid #ffeb3b;
            /* Yellow border to highlight */
            box-shadow: 0 0 10px rgba(255, 235, 59, 0.7);
        }


        main {
            display: flex;
            flex: 1;
            gap: 20px;
            flex-wrap: wrap;
            /* Allow wrapping on smaller screens */
            filter: var(--main-content-blur);
            /* Apply blur here */
            pointer-events: var(--main-content-pointer-events);
            /* Control interactions */
            user-select: var(--main-content-user-select);
            /* Control text selection */
            transition: filter 0.3s ease;
            /* Smooth transition for blur */
        }

        .calendar-container {
            background-color: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            flex: 1;
            min-width: 300px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            animation: float 3s ease-in-out infinite;
            /* Floating animation */
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .calendar-header button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            text-align: center;
        }

        .day-name {
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
        }

        .day {
            padding: 10px 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            position: relative;
            font-weight: bold;
        }

        .day:hover {
            background-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .day.selected {
            background-color: #f472b6;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .day.has-notes {
            position: relative;
        }

        /* Marcador de anotação (bolinha) */
        .day.has-notes::after {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--note-indicator-color);
            /* Utiliza a variável CSS */
            position: absolute;
            top: 5px;
            right: 5px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            box-shadow: 0 0 5px var(--note-indicator-color);
        }

        /* Borda de filtro */
        .day.filtered-day {
            outline: var(--filtered-day-border);
            outline-offset: 2px;
        }

        .day.current-day {
            outline: 3px solid #ffeb3b;
            /* Marker for current day */
            outline-offset: 2px;
            box-shadow: 0 0 15px rgba(255, 235, 59, 0.5);
            /* Glowing effect */
        }

        .notes-container {
            background-color: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            flex: 2;
            min-width: 400px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- START: New/Modified styles for add-note-section --- */
        .add-note-section {
            background-color: rgba(255, 255, 255, 0.2);
            /* Slightly brighter */
            border-radius: 15px;
            /* More rounded corners */
            padding: 25px;
            /* More padding */
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* Space between inputs */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            /* Softer shadow */
        }

        .notes-container h2.gradient-text {
            font-size: 2em;
            /* Ensure it matches the header h1 size */
            margin-bottom: 5px;
            /* Adjust spacing */
        }

        .notes-container #fullSelectedDateDisplay {
            font-size: 1.1em;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .input-group {
            position: relative;
            display: flex;
            /* For icon and input alignment */
            align-items: center;
        }

        .input-group .icon {
            position: absolute;
            left: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2em;
            pointer-events: none;
            /* Make sure icon doesn't block clicks on input */
            z-index: 10;
        }

        /* NEW: Labels in main content area */
        .add-note-section label {
            color: rgba(255, 255, 255, 0.9);
            /* White/light gray for contrast on dark background */
            font-weight: bold;
            font-size: 0.95em;
            margin-bottom: 5px;
            display: block;
        }

        .add-note-section input[type="text"],
        .add-note-section textarea {
            width: 100%;
            /* Full width */
            padding: 15px 15px 15px 45px;
            /* Left padding for icon */
            border: 1px solid rgba(255, 255, 255, 0.3);
            /* Subtle border */
            border-radius: 10px;
            /* More rounded input fields */
            background-color: rgba(255, 255, 255, 0.1);
            /* Lighter input background */
            color: white;
            font-size: 1.1em;
            outline: none;
            box-sizing: border-box;
            /* Include padding in width */
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .add-note-section textarea {
            padding-left: 15px;
            /* No icon for textarea usually, adjust if needed */
        }

        .add-note-section input::placeholder,
        .add-note-section textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .add-note-section input:focus,
        .add-note-section textarea:focus {
            border-color: #a78bfa;
            /* Highlight on focus */
            background-color: rgba(255, 255, 255, 0.15);
        }

        /* Char count display */
        .char-count-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        #charCount {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
            text-align: right;
            margin-top: -10px;
            /* Pull it closer to textarea */
        }

        .add-note-section button#addNoteBtn {
            background: linear-gradient(135deg, #f472b6, #a78bfa);
            /* Gradient button */
            color: white;
            border: none;
            padding: 15px;
            /* More padding */
            border-radius: 10px;
            /* More rounded button */
            cursor: pointer;
            font-size: 2em;
            /* Larger icon-like font size */
            font-weight: bold;
            display: flex;
            /* For centering content */
            justify-content: center;
            align-items: center;
            height: 60px;
            /* Fixed height for a square-ish button */
            width: 60px;
            /* Fixed width */
            align-self: flex-end;
            /* Align to the right, consistent with image */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            /* Stronger shadow */
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
            position: relative;
            /* For the plus sign */
        }

        /* Plus sign for the button */
        .add-note-section button#addNoteBtn::before {
            content: '+';
            font-size: 1em;
            /* Adjust size relative to button font-size */
            line-height: 1;
            /* Ensure vertical centering */
        }

        .add-note-section button#addNoteBtn:hover {
            background: linear-gradient(135deg, #e457a4, #926ee4);
            /* Darker gradient on hover */
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        /* Simplified add note button */
        .notes-container .simplified-add-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745, #218838);
            /* Green gradient */
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
            text-align: center;
            /* Ensure text is centered */
        }

        .notes-container .simplified-add-button:hover {
            background: linear-gradient(135deg, #218838, #1a6f2c);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        /* --- END: New/Modified styles for add-note-section --- */


        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-grow: 1;
            /* Allow notes list to fill available space */
            overflow-y: auto;
            /* Enable scrolling for notes if they overflow */
            padding-right: 10px;
            /* Space for scrollbar */
        }

        .note-card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .note-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .note-card h3 {
            margin: 0;
            color: #f472b6;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .note-card .reminder-bell {
            font-size: 1em;
            color: #FFC300;
            /* Yellow bell */
            margin-right: 5px;
        }

        .note-card p {
            margin: 0;
            font-size: 0.95em;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            white-space: pre-wrap;
            /* Preserve line breaks */
            word-wrap: break-word;
            /* Break long words */
        }

        .note-date-display {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .note-labels {
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .note-label {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.75em;
            text-transform: capitalize;
        }

        /* Etiqueta filtrada */
        .note-label.filtered {
            background-color: #ffeb3b;
            /* Yellow for emphasis */
            color: #333;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(255, 235, 59, 0.7);
        }


        .note-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .note-actions button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s ease;
        }

        .note-actions button:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        .note-actions .delete-btn {
            background-color: #e74c3c;
            /* Red for delete */
        }

        .note-actions .delete-btn:hover {
            background-color: #c0392b;
        }

        .note-actions .share-btn {
            background-color: #25D366;
            /* WhatsApp green */
            color: white;
        }

        .note-actions .share-btn:hover {
            background-color: #1DA851;
        }

        /* Modals (Edit, Confirm Delete, Share, Create Note, Reminder) */
        #editModalOverlay,
        #confirmModalOverlay,
        #shareModalOverlay,
        #createNoteModalOverlay,
        #reminderNotificationOverlay {
            display: none;
            /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            /* Darker overlay */
            backdrop-filter: blur(8px);
            /* More blur for a stronger effect */
            z-index: 1050;
            /* Above sidebar */
            justify-content: center;
            align-items: center;
        }

        #editModalOverlay.active,
        #confirmModalOverlay.active,
        #shareModalOverlay.active,
        #createNoteModalOverlay.active,
        #reminderNotificationOverlay.active {
            display: flex;
        }

        .edit-modal-content,
        .confirm-modal-content,
        .share-modal-content,
        .create-note-modal-content,
        .reminder-notification-content {
            background-color: rgba(255, 255, 255, 0.95);
            /* Lighter modal background */
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            color: #333;
            /* Dark text for modal content */
            position: relative;
            /* For close button */
        }

        /* Close button for modals */
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2em;
            color: #666;
            cursor: pointer;
            background: none;
            border: none;
            line-height: 1;
        }

        .modal-close-btn:hover {
            color: #333;
        }

        .edit-modal-content h3,
        .confirm-modal-content h3,
        .share-modal-content h3,
        .create-note-modal-content h3,
        .reminder-notification-content h3 {
            margin-top: 0;
            color: #a78bfa;
            font-size: 1.8em;
        }

        .modal-input-group label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
            color: #555;
            /* Default text color for labels in modals */
            font-size: 0.9em;
        }

        /* Improvement for visibility for 'Cor do Marcador' */
        .modal-input-group label[for="markerColorLabel"],
        .modal-input-group label#markerColorLabelEdit {
            color: #333;
            /* Stronger color for contrast on modal background */
            font-weight: bold;
            font-size: 1em;
            /* Slightly larger */
        }

        .modal-input-group {
            margin-bottom: 10px;
            /* Spacing between labeled inputs */
        }

        .edit-modal-content input[type="text"],
        .edit-modal-content textarea,
        .share-modal-content input[type="tel"],
        .create-note-modal-content input[type="text"],
        .create-note-modal-content textarea {
            /* Style for phone number input */
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            color: #333;
            background-color: #f9f9f9;
            box-sizing: border-box;
        }

        .edit-modal-content textarea,
        .create-note-modal-content textarea {
            height: 150px;
            resize: vertical;
        }

        /* Character count in modals */
        .modal-char-count {
            font-size: 0.85em;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }

        .edit-modal-buttons,
        .confirm-modal-buttons,
        .share-modal-buttons,
        .create-note-modal-buttons,
        .reminder-notification-content .notification-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .edit-modal-buttons button,
        .confirm-modal-buttons button,
        .share-modal-buttons button,
        .create-note-modal-buttons button,
        .reminder-notification-content .notification-actions button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .edit-modal-buttons button:hover,
        .confirm-modal-buttons button:hover,
        .share-modal-buttons button:hover,
        .create-note-modal-buttons button:hover,
        .reminder-notification-content .notification-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        #saveEditedNote,
        #confirmDeleteBtn,
        #confirmShareBtn,
        #saveNewNoteBtn {
            background-color: #28a745;
            color: white;
        }

        #saveEditedNote:hover,
        #confirmDeleteBtn:hover,
        #confirmShareBtn:hover,
        #saveNewNoteBtn:hover {
            background-color: #218838;
        }

        #cancelEdit,
        #cancelDeleteBtn,
        #cancelShareBtn,
        #cancelNewNoteBtn {
            background-color: #dc3545;
            color: white;
        }

        #cancelEdit:hover,
        #cancelDeleteBtn:hover,
        #cancelShareBtn:hover,
        #cancelNewNoteBtn:hover {
            background-color: #c82333;
        }

        /* Marker Color Palette */
        .marker-color-palette {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .marker-color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #ccc;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .marker-color-option:hover {
            transform: scale(1.1);
            border-color: #a78bfa;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .marker-color-option.selected {
            border: 3px solid #a78bfa;
            transform: scale(1.15);
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.7);
        }

        /* NEW: Disabled marker color option */
        .marker-color-palette.disabled .marker-color-option {
            cursor: not-allowed;
            opacity: 0.5;
            pointer-events: none;
            /* Disable clicks */
            border-color: #eee;
            box-shadow: none;
            transform: none;
        }

        .marker-color-palette.disabled .marker-color-option.selected {
            border: 3px solid #ccc;
            /* Keep border but less prominent */
            box-shadow: none;
        }


        /* Reminder toggle */
        .reminder-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #333;
            /* Default for modals, adjusted for main area below */
        }

        /* NEW: Reminder toggle in main content area */
        .add-note-section .reminder-toggle label {
            color: rgba(255, 255, 255, 0.9);
            /* White/light gray for contrast on dark background */
            font-weight: normal;
        }


        .reminder-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Basic styling for print output */
        @media print {
            body *:not(#printableContent):not(#printableContent *) {
                display: none !important;
                /* Hide all elements not part of printableContent */
                visibility: hidden !important;
            }

            html,
            body {
                height: auto !important;
                overflow: visible !important;
                background: none !important;
                /* No background on print */
            }

            #printableContent {
                display: block !important;
                visibility: visible !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-sizing: border-box;
                color: #000;
                /* Black text for print */
                font-family: sans-serif;
                padding: 20px;
                /* Add padding to the print area */
                page-break-before: auto;
                /* Allow page breaks before this element if necessary */
                page-break-after: auto;
                /* Allow page breaks after this element if necessary */
            }

            #printableContent h2 {
                text-align: center;
                margin-bottom: 25px;
                /* More space for title */
                color: #000;
                font-size: 1.8em;
                page-break-after: avoid;
                /* Keep title with first note if possible */
            }

            #printableContent .note-card {
                border: 1px solid #ccc;
                background-color: #fcfcfc;
                margin-bottom: 25px;
                /* Spacing between notes */
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: none;
                /* No shadows on print */
                page-break-inside: avoid;
                /* Keep note on one page if possible */
            }

            #printableContent .note-card h3 {
                color: #333;
                font-size: 1.3em;
                margin-bottom: 8px;
                display: block;
                /* Ensure it takes full width */
                page-break-after: avoid;
            }

            #printableContent .note-card p {
                color: #555;
                font-size: 1em;
                line-height: 1.5;
                margin-bottom: 12px;
                page-break-before: avoid;
            }

            #printableContent .note-date-print {
                font-size: 0.8em;
                color: #777;
                text-align: right;
                border-top: 1px dashed #ddd;
                padding-top: 10px;
            }

            /* Hide elements not needed in print */
            .note-labels,
            .note-actions,
            .reminder-bell {
                display: none !important;
            }

            /* For multiple pages */
            @page {
                margin: 2cm;
                /* Standard print margins */
            }
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
                /* Spread filter and menu button */
                flex-wrap: wrap;
                /* Allow search and filter to wrap */
                gap: 10px;
                /* Adjust gap for smaller screens */
            }

            .search-container,
            .filter-container {
                width: 100%;
                /* Make them full width */
            }

            main {
                flex-direction: column;
                padding: 10px;
                /* Adjust padding for smaller screens */
            }

            .calendar-container,
            .notes-container {
                min-width: unset;
                width: 100%;
                padding: 15px;
                /* Adjust padding for smaller screens */
            }

            #sidebar.open {
                width: 75%;
                /* Adjusted width for better fit on small screens */
                padding-left: 15px;
                padding-right: 15px;
            }

            #sidebar h2 {
                margin-bottom: 20px;
                font-size: 1.5em;
            }

            .sidebar-section-header h3 {
                font-size: 1em;
            }

            .sidebar-section-content button,
            .sidebar-section-content select {
                padding: 10px;
                font-size: 0.9em;
            }

            .sidebar-section-content button::before {
                width: 16px;
                height: 16px;
                margin-right: 8px;
            }


            .gradient-text {
                font-size: 1.5em;
            }

            header {
                padding: 0 10px;
            }

            .edit-modal-content,
            .confirm-modal-content,
            .share-modal-content,
            .create-note-modal-content,
            .reminder-notification-content {
                width: 95%;
                padding: 20px;
            }

            .note-actions {
                position: static;
                /* Stack buttons on smaller screens if needed */
                margin-top: 10px;
                justify-content: flex-end;
            }

            .add-note-section input[type="text"],
            .add-note-section textarea {
                padding: 12px 10px 12px 40px;
                /* Adjust padding for icons on smaller screens */
            }

            .add-note-section textarea {
                padding-left: 10px;
                /* No icon for textarea usually, adjust if needed */
            }

            .header-left {
                flex-direction: row;
                /* Keep row for small screens to prevent logo stack */
                align-items: center;
            }

            .header-title-container {
                flex-direction: column;
                align-items: flex-start;
            }

            #usernameDisplay {
                margin-left: 0;
                /* Remove left margin for better alignment on small screens */
            }
        }

        /* --- DESKTOP SPECIFIC ADJUSTMENTS FOR SIDEBAR --- */
        @media (min-width: 769px) {
            #sidebar.open {
                width: 250px;
                /* A slightly narrower width for desktop */
                padding-left: 15px;
                padding-right: 15px;
            }

            #sidebar h2 {
                font-size: 1.5em;
                margin-bottom: 20px;
            }

            .sidebar-section-header h3 {
                font-size: 1.1em;
            }

            .sidebar-section-content button,
            .sidebar-section-content select {
                padding: 10px 12px;
                /* Make buttons and selects slightly smaller */
                font-size: 0.95em;
                /* Smaller font size */
            }

            .sidebar-section-content button::before {
                width: 18px;
                height: 18px;
                margin-right: 8px;
            }
        }


        /* Styles for label filter in header */
        .filter-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
            /* Allow filter to grow */
        }

        .filter-container label {
            display: none;
            /* Hide the label as text is now inside select */
        }

        .filter-container select {
            padding: 10px 15px;
            /* Increased padding */
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 1em;
            outline: none;
            box-sizing: border-box;
            appearance: none;
            -webkit-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-6.5%200-12.3%203.8-15%209.7-2.7%205.9-1.2%2012.8%203.4%2017.4l137.2%20137.2c3.9%203.9%209%205.9%2014.1%205.9s10.2-2%2014.1-5.9l137.2-137.2c4.6-4.6%206.1-11.5%203.4-17.4z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px auto;
            min-width: 150px;
            /* Ensure minimum width */
            flex-grow: 1;
            /* Allow it to take available space */
        }

        .filter-container select option {
            background-color: #1a1a1a;
            /* Darker background for options */
            color: white;
            padding: 5px;
        }

        /* Auto Delete Options styles */
        #autoDeleteOptionsContent select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            /* Lighter border for contrast */
            background-color: rgba(255, 255, 255, 0.15);
            /* Slightly transparent white for background */
            color: white;
            /* Ensure text is white */
            font-size: 1em;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            appearance: none;
            -webkit-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-6.5%200-12.3%203.8-15%209.7-2.7%205.9-1.2%2012.8%203.4%2017.4l137.2%20137.2c3.9%203.9%209%205.9%2014.1%205.9s10.2-2%2014.1-5.9l137.2-137.2c4.6-4.6%206.1-11.5%203.4-17.4z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px auto;
        }

        /* Ensure options in select are readable */
        #autoDeleteOptionsContent select option {
            background-color: #1a1a1a;
            /* Dark background for options */
            color: white;
            /* White text for options */
            padding: 5px;
        }

        /* Search Bar Styles */
        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            flex-grow: 1;
            /* Allow search bar to grow */
        }

        #noteSearch {
            width: 100%;
            padding: 10px 15px 10px 40px;
            /* Adjust padding for icon */
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 1em;
            outline: none;
            box-sizing: border-box;
            transition: border-color 0.3s ease, background-color 0.3s ease;
            min-width: 150px;
        }

        #noteSearch::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        #noteSearch:focus {
            border-color: #f472b6;
            background-color: rgba(255, 255, 255, 0.2);
        }

        .search-container::before {
            content: "\1F50D";
            /* Unicode for search icon */
            font-family: 'Arial Unicode MS', 'DejaVu Sans', sans-serif;
            /* Ensure icon renders */
            position: absolute;
            left: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1em;
            pointer-events: none;
        }

        /* Reminder Notification styles */
        #reminderNotificationOverlay {
            z-index: 1060;
            /* Above other modals */
        }

        .reminder-notification-content {
            background-color: rgba(255, 255, 255, 0.98);
            border: 2px solid #a78bfa;
            color: #333;
        }

        .reminder-note-item {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #a78bfa;
        }

        .reminder-note-item h4 {
            margin: 0 0 5px 0;
            color: #a78bfa;
        }

        .reminder-note-item p {
            margin: 0;
            font-size: 0.9em;
            color: #555;
        }
    </style>
</head>

<body data-theme="default">
    <header>
        <div class="header-left">
            <div class="header-title-container">
                <img src="—Pngtree—three-dimensional diary_5410276.png" alt="Diário Logo">
                <h1 class="gradient-text">Diário Digital</h1>
            </div>
            <p id="usernameDisplay"></p> </div>
        <div class="header-right" style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <div class="search-container">
                <input type="text" id="noteSearch" placeholder="Pesquisar anotações...">
            </div>
            <div class="filter-container">
                <label for="labelFilter">Filtrar por Etiqueta:</label>
                <select id="labelFilter">
                    <option value="">Filtrar por Etiqueta</option>
                </select>
            </div>
            <button id="menuButton">&#9776;</button> </div>
    </header>

    <aside id="sidebar">
        <a href="javascript:void(0)" id="closeSidebar">&times;</a>
        <h2>Configurações</h2>

        <div class="sidebar-section">
            <div class="sidebar-section-header" data-target="colorOptionsContent">
                <h3>Cor de Fundo</h3>
                <span class="arrow-icon">&gt;</span>
            </div>
            <div class="sidebar-section-content" id="colorOptionsContent">
                <button data-color="linear-gradient(135deg, #ff00ff 0%, #8000ff 100%)">Roxo Mágico</button>
                <button data-color="linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)">Céu Azul</button>
                <button data-color="linear-gradient(135deg, #00ff00 0%, #008000 100%)">Verde Floresta</button>
                <button data-color="linear-gradient(135deg, #ffcc00 0%, #ff6600 100%)">Pôr do Sol</button>
                <button data-color="linear-gradient(135deg, #000000 0%, #333333 100%)">Noite Escura</button>
                <button data-color="linear-gradient(135deg, #A020F0 0%, #5C2B6A 100%)">Padrão</button>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-header" data-target="printOptionsContent">
                <h3>Imprimir Anotações</h3>
                <span class="arrow-icon">&gt;</span>
            </div>
            <div class="sidebar-section-content" id="printOptionsContent">
                <button id="printDayNotesBtn">Dia Selecionado</button>
                <button id="printWeekNotesBtn">Semana Atual</button>
                <button id="printMonthNotesBtn">Mês Atual</button>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-header" data-target="autoDeleteOptionsContent">
                <h3>Excluir Anotações Antigas</h3>
                <span class="arrow-icon">&gt;</span>
            </div>
            <div class="sidebar-section-content" id="autoDeleteOptionsContent">
                <select id="autoDeleteInterval">
                    <option value="never">Nunca</option>
                    <option value="1_day">Após 1 dia</option>
                    <option value="1_week">Após 1 semana</option>
                    <option value="1_month">Após 1 mês</option>
                </select>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-header">
                <h3>Sessão</h3>
                <span class="arrow-icon">&gt;</span>
            </div>
            <div class="sidebar-section-content"
                style="max-height: 100px; opacity: 1; padding-top: 15px;">
                <button id="logoutButton"
                    style="background-color: #dc3545; color: white; text-align: center;">Sair / Deslogar</button>
            </div>
        </div>
    </aside>

    <main>
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prevMonthBtn">&lt;</button>
                <h2 id="monthYear"></h2>
                <button id="nextMonthBtn">&gt;</button>
            </div>
            <div class="calendar-grid">
                <div class="day-name">Dom</div>
                <div class="day-name">Seg</div>
                <div class="day-name">Ter</div>
                <div class="day-name">Qua</div>
                <div class="day-name">Qui</div>
                <div class="day-name">Sex</div>
                <div class="day-name">Sáb</div>
            </div>
            <div class="calendar-grid" id="calendarDays">
                </div>
        </div>

        <div class="notes-container">
            <h2 class="gradient-text">Anotações do Dia</h2>
            <p id="fullSelectedDateDisplay"></p>

            <div id="addNoteAreaWrapper">
                </div>

            <div class="notes-list" id="notesList">
                </div>
        </div>
    </main>

    <div id="createNoteModalOverlay">
        <div class="create-note-modal-content">
            <button class="modal-close-btn" onclick="closeCreateNoteModal()">&times;</button>
            <h3>Criar Anotação</h3>
            <div class="modal-input-group">
                <label for="newNoteTitle">Título:</label>
                <input type="text" id="newNoteTitle" placeholder="Título da Anotação">
            </div>
            <div class="modal-input-group">
                <label for="newNoteLabels">Etiquetas (separadas por vírgula):</label>
                <input type="text" id="newNoteLabels" placeholder="Etiquetas (ex: trabalho, pessoal)">
            </div>
            <div class="modal-input-group">
                <label id="markerColorLabel">Cor do Marcador:</label>
                <div class="marker-color-palette" id="newNoteMarkerColorPalette">
                    <div class="marker-color-option selected" data-color="#6dff6d" style="background-color: #6dff6d;">
                    </div>
                    <div class="marker-color-option" data-color="#FF5733" style="background-color: #FF5733;"></div>
                    <div class="marker-color-option" data-color="#337AFF" style="background-color: #337AFF;"></div>
                    <div class="marker-color-option" data-color="#FFC300" style="background-color: #FFC300;"></div>
                    <div class="marker-color-option" data-color="#900C3F" style="background-color: #900C3F;"></div>
                </div>
            </div>
            <div class="modal-input-group">
                <label for="newNoteContent">Texto:</label>
                <textarea id="newNoteContent" placeholder="Escreva sua anotação aqui..." maxlength="200"
                    onkeyup="updateModalCharCount('newNoteContent', 'newNoteCharCount')"
                    onpaste="updateModalCharCount('newNoteContent', 'newNoteCharCount')"></textarea>
                <span class="modal-char-count" id="newNoteCharCount">200 caracteres restantes</span>
            </div>
            <div class="reminder-toggle">
                <input type="checkbox" id="newNoteReminderToggle">
                <label for="newNoteReminderToggle">Ativar Lembrete</label>
            </div>
            <div class="create-note-modal-buttons">
                <button id="saveNewNoteBtn">Salvar</button>
                <button id="cancelNewNoteBtn">Cancelar</button>
            </div>
        </div>
    </div>


    <div id="editModalOverlay">
        <div class="edit-modal-content">
            <button class="modal-close-btn" onclick="closeEditModal()">&times;</button>
            <h3>Editar Anotação</h3>
            <div class="modal-input-group">
                <label for="editNoteTitle">Título:</label>
                <input type="text" id="editNoteTitle" placeholder="Novo Título">
            </div>
            <div class="modal-input-group">
                <label for="editNoteLabels">Etiquetas (separadas por vírgula):</label>
                <input type="text" id="editNoteLabels" placeholder="Etiquetas (ex: trabalho, pessoal)">
            </div>
            <div class="modal-input-group">
                <label id="markerColorLabelEdit">Cor do Marcador:</label>
                <div class="marker-color-palette" id="editNoteMarkerColorPalette">
                    <div class="marker-color-option" data-color="#6dff6d" style="background-color: #6dff6d;"></div>
                    <div class="marker-color-option" data-color="#FF5733" style="background-color: #FF5733;"></div>
                    <div class="marker-color-option" data-color="#337AFF" style="background-color: #337AFF;"></div>
                    <div class="marker-color-option" data-color="#FFC300" style="background-color: #FFC300;"></div>
                    <div class="marker-color-option" data-color="#900C3F" style="background-color: #900C3F;"></div>
                </div>
            </div>
            <div class="modal-input-group">
                <label for="editNoteContent">Texto:</label>
                <textarea id="editNoteContent" placeholder="Novo Conteúdo" maxlength="200"
                    onkeyup="updateModalCharCount('editNoteContent', 'editNoteCharCount')"
                    onpaste="updateModalCharCount('editNoteContent', 'editNoteCharCount')"></textarea>
                <span class="modal-char-count" id="editNoteCharCount">200 caracteres restantes</span>
            </div>
            <div class="reminder-toggle">
                <input type="checkbox" id="editNoteReminderToggle">
                <label for="editNoteReminderToggle">Ativar Lembrete</label>
            </div>
            <div class="edit-modal-buttons">
                <button id="saveEditedNote">Salvar</button>
                <button id="cancelEdit">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="confirmModalOverlay">
        <div class="confirm-modal-content">
            <button class="modal-close-btn" onclick="closeConfirmDeleteModal()">&times;</button>
            <h3>Confirmar Exclusão</h3>
            <p>Tem certeza que deseja apagar esta anotação?</p>
            <div class="confirm-modal-buttons">
                <button id="confirmDeleteBtn">Sim, Apagar</button>
                <button id="cancelDeleteBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="shareModalOverlay">
        <div class="share-modal-content">
            <button class="modal-close-btn" onclick="closeShareModal()">&times;</button>
            <h3>Compartilhar Anotação via WhatsApp</h3>
            <p>A anotação será compartilhada com o título e conteúdo.</p>
            <input type="tel" id="whatsappNumber" placeholder="Número do WhatsApp (ex: 55 DDD XXXXXXXXX)"
                pattern="[0-9+ ]+">
            <div class="share-modal-buttons">
                <button id="confirmShareBtn">Compartilhar</button>
                <button id="cancelShareBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="reminderNotificationOverlay">
        <div class="reminder-notification-content">
            <button class="modal-close-btn" onclick="closeReminderNotification()">&times;</button>
            <h3>Lembretes para Hoje</h3>
            <div id="reminderNotesList">
                </div>
            <div class="notification-actions">
                <button onclick="closeReminderNotification()">Entendi</button>
            </div>
        </div>
    </div>

    <div id="printableContent" style="display: none;"></div>


    <script>
        const monthYearEl = document.getElementById('monthYear');
        const calendarDaysEl = document.getElementById('calendarDays');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const fullSelectedDateDisplay = document.getElementById('fullSelectedDateDisplay'); // New element for full date
        const usernameDisplay = document.getElementById('usernameDisplay'); // Element to display username

        const notesListEl = document.getElementById('notesList');
        const noteSearchInput = document.getElementById('noteSearch'); // Search input element

        // Elements for sidebar
        const menuButton = document.getElementById('menuButton');
        const sidebar = document.getElementById('sidebar');
        const closeSidebar = document.getElementById('closeSidebar');

        // NEW: Sidebar accordion sections
        const sidebarSections = document.querySelectorAll('.sidebar-section');


        // Elements for filter
        const labelFilter = document.getElementById('labelFilter');

        // Elements for edit modal
        const editModalOverlay = document.getElementById('editModalOverlay');
        const editNoteTitleInput = document.getElementById('editNoteTitle');
        const editNoteContentInput = document.getElementById('editNoteContent');
        const editNoteLabelsInput = document.getElementById('editNoteLabels');
        const editNoteMarkerColorPalette = document.getElementById('editNoteMarkerColorPalette');
        const editNoteReminderToggle = document.getElementById('editNoteReminderToggle');
        const saveEditedNoteBtn = document.getElementById('saveEditedNote');
        const cancelEditBtn = document.getElementById('cancelEdit');

        // Elements for confirm delete modal
        const confirmModalOverlay = document.getElementById('confirmModalOverlay');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        // Elements for share modal
        const shareModalOverlay = document.getElementById('shareModalOverlay');
        const whatsappNumberInput = document.getElementById('whatsappNumber');
        const confirmShareBtn = document.getElementById('confirmShareBtn');
        const cancelShareBtn = document.getElementById('cancelShareBtn');

        // NOVA FUNCIONALIDADE: Elementos do modal de criação
        const addNoteAreaWrapper = document.getElementById('addNoteAreaWrapper'); // Wrapper para o botão/formulário de adicionar
        const createNoteModalOverlay = document.getElementById('createNoteModalOverlay');
        const newNoteTitleInput = document.getElementById('newNoteTitle');
        const newNoteLabelsInput = document.getElementById('newNoteLabels');
        const newNoteContentInput = document.getElementById('newNoteContent');
        const newNoteMarkerColorPalette = document.getElementById('newNoteMarkerColorPalette');
        const newNoteReminderToggle = document.getElementById('newNoteReminderToggle');
        const saveNewNoteBtn = document.getElementById('saveNewNoteBtn');
        const cancelNewNoteBtn = document.getElementById('cancelNewNoteBtn');

        // NOVA FUNCIONALIDADE: Elementos do lembrete
        const reminderNotificationOverlay = document.getElementById('reminderNotificationOverlay');
        const reminderNotesList = document.getElementById('reminderNotesList');

        // NOVA FUNCIONALIDADE: Elementos de impressão
        const printDayNotesBtn = document.getElementById('printDayNotesBtn');
        const printWeekNotesBtn = document.getElementById('printWeekNotesBtn');
        const printMonthNotesBtn = document.getElementById('printMonthNotesBtn');
        const printableContent = document.getElementById('printableContent');

        // Auto delete select element
        const autoDeleteIntervalSelect = document.getElementById('autoDeleteInterval');

        // Logout button
        const logoutButton = document.getElementById('logoutButton');


        let currentDate = new Date();
        let today = new Date(); // To mark the current day
        let selectedDay = currentDate.getDate();

        // --- GLOBAL DATA FOR CURRENT USER ---
        let currentUser = null; // Will store { username: "..." }
        let notes = {}; // Will store notes for the currentUser
        let preferences = {}; // Will store preferences for the currentUser

        let editingNoteInfo = null; // Stores {day, index} of the note being edited
        let noteToDeleteInfo = null; // Stores {day, index} of the note to be deleted
        let noteToShareInfo = null; // Stores {title, content} of the note to be shared
        let activeLabelFilter = ''; // Stores the currently selected label for filtering
        let activeSearchQuery = ''; // Stores the current search query
        let selectedMarkerColor = '#6dff6d'; // Default marker color for new notes
        let lastSelectedPrintOption = null; // NEW: To keep track of the last clicked print button


        const monthNames = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        const dayNames = [
            'domingo', 'segunda-feira', 'terça-feira', 'quarta-feira', 'quinta-feira', 'sexta-feira', 'sábado'
        ];

        const MAX_CHARS = 200; // Max characters for note content

        // --- USER DATA MANAGEMENT (NEW/MODIFIED) ---

        // This object will hold all users' data, keyed by username
        // It's a good practice to keep this in localStorage to persist across sessions
        let allUsersData = JSON.parse(localStorage.getItem('allUsersData')) || {};

        function loadUserData() {
            currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

            if (!currentUser || !currentUser.username) {
                // If no user is logged in, redirect to login page
                window.location.href = 'Login.html';
                return false; // Stop execution
            }

            usernameDisplay.textContent = `Usuário: ${currentUser.username}`;

            // Initialize data for the current user if they don't exist in allUsersData
            if (!allUsersData[currentUser.username]) {
                allUsersData[currentUser.username] = {
                    notes: {},
                    preferences: {
                        selectedThemeColor: 'linear-gradient(135deg, #A020F0 0%, #5C2B6A 100%)', // Default theme
                        autoDeleteInterval: 'never' // Default auto-delete
                    }
                };
            }

            // Assign current user's specific notes and preferences
            notes = allUsersData[currentUser.username].notes;
            preferences = allUsersData[currentUser.username].preferences;

            // Apply loaded preferences
            loadTheme();
            autoDeleteIntervalSelect.value = preferences.autoDeleteInterval || 'never';

            return true; // User data loaded successfully
        }

        function saveUserData() {
            if (currentUser && currentUser.username) {
                allUsersData[currentUser.username] = {
                    notes: notes,
                    preferences: preferences
                };
                localStorage.setItem('allUsersData', JSON.stringify(allUsersData));
            }
        }

        // --- THEME LOAD/SAVE (MODIFIED TO USE PREFERENCES) ---
        function loadTheme() {
            const savedColor = preferences.selectedThemeColor;
            if (savedColor) {
                document.documentElement.style.setProperty('--bg-gradient', savedColor);
                // Also update the selected theme button
                const themeButtons = document.querySelectorAll('#colorOptionsContent button');
                themeButtons.forEach(button => {
                    button.classList.remove('selected-theme');
                    if (button.dataset.color === savedColor) {
                        button.classList.add('selected-theme');
                    }
                });
            } else {
                // If no saved color, ensure default theme button is selected
                document.querySelector('#colorOptionsContent button[data-color*="A020F0"]').classList.add('selected-theme');
                document.documentElement.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #A020F0 0%, #5C2B6A 100%)');
            }
        }

        function saveTheme(color) {
            preferences.selectedThemeColor = color;
            saveUserData();
        }
        // --- END THEME LOAD/SAVE ---

        // NOVA FUNCIONALIDADE: Contador de caracteres para modais
        function updateModalCharCount(inputId, charCountId) {
            const inputEl = document.getElementById(inputId);
            const charCountEl = document.getElementById(charCountId);
            const currentLength = inputEl.value.length;
            const remaining = MAX_CHARS - currentLength;
            charCountEl.textContent = `${remaining} caracteres restantes`;
            if (remaining < 0) {
                charCountEl.style.color = 'red';
            } else {
                charCountEl.style.color = '#666';
            }
        }

        function renderCalendar() {
            calendarDaysEl.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthYearEl.textContent = `${monthNames[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Add empty days for the offset
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('day');
                calendarDaysEl.appendChild(emptyDay);
            }

            // Add actual days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                dayEl.textContent = day;
                dayEl.dataset.day = day;

                const fullDateKey = `${day}-${month + 1}-${year}`;
                if (notes[fullDateKey] && notes[fullDateKey].length > 0) {
                    dayEl.classList.add('has-notes');
                    // Define a cor do marcador com base na PRIMEIRA anotação, ou padrão se não definida
                    const firstNoteColor = notes[fullDateKey][0].markerColor || '#6dff6d';
                    dayEl.style.setProperty('--note-indicator-color', firstNoteColor);
                } else {
                    dayEl.style.removeProperty('--note-indicator-color');
                }

                // Mark current day
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayEl.classList.add('current-day');
                }

                if (day === selectedDay && month === currentDate.getMonth() && year === currentDate.getFullYear()) {
                    dayEl.classList.add('selected');
                }

                // CORREÇÃO: Adicionar borda amarela APENAS se o filtro estiver ativo E o dia tiver anotação com a etiqueta filtrada
                if (activeLabelFilter) { // Only apply if a filter is actually active
                    const notesOnThisDay = notes[fullDateKey] || [];
                    const hasFilteredNote = notesOnThisDay.some(note =>
                        note.labels && note.labels.includes(activeLabelFilter)
                    );
                    if (hasFilteredNote) {
                        dayEl.classList.add('filtered-day');
                    } else {
                        dayEl.classList.remove('filtered-day');
                    }
                } else {
                    dayEl.classList.remove('filtered-day'); // Ensure it's removed if no filter is active
                }


                dayEl.addEventListener('click', () => {
                    selectedDay = day;
                    activeLabelFilter = ''; // Reset filter when a day is clicked
                    labelFilter.value = ''; // Update filter dropdown
                    activeSearchQuery = ''; // Reset search when a day is clicked
                    noteSearchInput.value = ''; // Update search input
                    // Remove 'selected' from previously selected day
                    const prevSelected = document.querySelector('.day.selected');
                    if (prevSelected) {
                        prevSelected.classList.remove('selected');
                    }
                    dayEl.classList.add('selected');
                    renderNotes();
                    renderAddNoteArea(); // Atualizar a área de adicionar anotação
                });
                calendarDaysEl.appendChild(dayEl);
            }
            populateLabelFilter(); // Populate filter whenever calendar is rendered (new notes might be added)
            renderNotes(); // Re-render notes for the initially selected day or filtered
            renderAddNoteArea(); // Renderiza a área de adicionar anotação inicial
        }

        // NOVA FUNCIONALIDADE: Renderizar a área de adicionar anotação
        function renderAddNoteArea() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const fullDateKey = `${selectedDay}-${month + 1}-${year}`;
            const hasNotesForSelectedDay = notes[fullDateKey] && notes[fullDateKey].length > 0;

            if (hasNotesForSelectedDay) {
                addNoteAreaWrapper.innerHTML = `
                    <button id="showCreateNoteModalBtn" class="simplified-add-button">Criar nova anotação</button>
                `;
                document.getElementById('showCreateNoteModalBtn').addEventListener('click', openCreateNoteModal);
            } else {
                // If no notes, show the full form, and reset selectedMarkerColor to default
                selectedMarkerColor = '#6dff6d'; // Reset to default green for a fresh day
                addNoteAreaWrapper.innerHTML = `
                    <div class="add-note-section">
                        <div class="modal-input-group">
                            <label for="noteTitle">Título:</label>
                            <div class="input-group">
                                <span class="icon">&#9999;</span> <input type="text" id="noteTitle" placeholder="Título da Anotação">
                            </div>
                        </div>
                        <div class="modal-input-group">
                            <label for="noteLabels">Etiquetas (separando por vírgula):</label>
                            <div class="input-group">
                                <span class="icon">&#127997;</span> <input type="text" id="noteLabels" placeholder="Etiquetas (ex: trabalho, pessoal)">
                            </div>
                        </div>
                        <div class="modal-input-group">
                            <label id="markerColorLabel">Cor do Marcador:</label>
                            <div class="marker-color-palette" id="mainAddNoteMarkerColorPalette">
                                <div class="marker-color-option selected" data-color="#6dff6d" style="background-color: #6dff6d;"></div>
                                <div class="marker-color-option" data-color="#FF5733" style="background-color: #FF5733;"></div>
                                <div class="marker-color-option" data-color="#337AFF" style="background-color: #337AFF;"></div>
                                <div class="marker-color-option" data-color="#FFC300" style="background-color: #FFC300;"></div>
                                <div class="marker-color-option" data-color="#900C3F" style="background-color: #900C3F;"></div>
                            </div>
                        </div>
                        <div class="modal-input-group">
                            <label for="noteContent">Texto:</label>
                            <textarea id="noteContent" placeholder="Escreva sua anotação aqui..." maxlength="200"
                                onkeyup="updateCharCount()" onpaste="updateCharCount()"></textarea>
                            <span class="modal-char-count" id="charCount">200 caracteres restantes</span>
                        </div>
                        <div class="reminder-toggle">
                            <input type="checkbox" id="mainNoteReminderToggle">
                            <label for="mainNoteReminderToggle">Ativar Lembrete</label>
                        </div>
                        <button id="addNoteBtn"></button>
                    </div>
                `;
                // Re-adiciona event listeners aos elementos recém-criados
                document.getElementById('addNoteBtn').addEventListener('click', addNote);
                document.getElementById('noteContent').addEventListener('keyup', updateCharCount);
                document.getElementById('noteContent').addEventListener('paste', updateCharCount);
                addMarkerColorPaletteListeners('mainAddNoteMarkerColorPalette');
                updateCharCount(); // Initialize char count for the main input area
            }
        }

        // CORREÇÃO: Função para atualizar o contador de caracteres na área principal
        function updateCharCount() {
            const inputEl = document.getElementById('noteContent');
            const charCountEl = document.getElementById('charCount');
            if (inputEl && charCountEl) {
                const currentLength = inputEl.value.length;
                const remaining = MAX_CHARS - currentLength;
                charCountEl.textContent = `${remaining} caracteres restantes`;
                if (remaining < 0) {
                    charCountEl.style.color = 'red';
                } else {
                    charCountEl.style.color = 'rgba(255, 255, 255, 0.7)';
                }
            }
        }


        function renderNotes() {
            notesListEl.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const fullDateKey = `${selectedDay}-${month + 1}-${year}`;

            const selectedDateObj = new Date(year, month, selectedDay);
            const dayOfWeek = dayNames[selectedDateObj.getDay()];
            const formattedDate = `${dayOfWeek}, ${selectedDay} de ${monthNames[month]} de ${year}`;
            fullSelectedDateDisplay.textContent = activeLabelFilter || activeSearchQuery ? 'Resultados da Busca/Filtro:' : formattedDate;


            let notesToDisplay = [];

            // Se houver pesquisa ativa, ignore o filtro de data e busque em todas as anotações
            if (activeSearchQuery) {
                const query = activeSearchQuery.toLowerCase().trim();
                // Usar RegExp para buscar por palavras completas e considerar plural/singular
                const searchRegex = new RegExp(`\\b${query}(s)?\\b`, 'i'); // (s)? para singular/plural
                Object.values(notes).forEach(dayNotes => {
                    dayNotes.forEach(note => {
                        if (searchRegex.test(note.title) || searchRegex.test(note.content)) {
                            notesToDisplay.push(note);
                        }
                    });
                });
            } else if (activeLabelFilter) {
                // Se houver filtro de etiqueta, busque em todas as anotações com a etiqueta
                Object.values(notes).forEach(dayNotes => {
                    dayNotes.forEach(note => {
                        if (note.labels && note.labels.includes(activeLabelFilter)) {
                            notesToDisplay.push(note);
                        }
                    });
                });
            } else {
                // Caso contrário, mostre as anotações do dia selecionado
                if (notes[fullDateKey] && notes[fullDateKey].length > 0) {
                    notesToDisplay = [...notes[fullDateKey]];
                }
            }


            if (notesToDisplay.length > 0) {
                // Ordenar notas por timestamp (mais recente primeiro)
                notesToDisplay.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                notesToDisplay.forEach((note, index) => {
                    const noteCard = document.createElement('div');
                    noteCard.classList.add('note-card');

                    const titleEl = document.createElement('h3');
                    // NOVA FUNCIONALIDADE: Adicionar sininho se lembrete ativo
                    if (note.reminder) {
                        const bellIcon = document.createElement('span');
                        bellIcon.classList.add('reminder-bell');
                        bellIcon.textContent = '🔔'; // Unicode bell icon
                        titleEl.appendChild(bellIcon);
                    }
                    titleEl.appendChild(document.createTextNode(note.title)); // Append text after bell
                    noteCard.appendChild(titleEl);

                    const contentEl = document.createElement('p');
                    contentEl.textContent = note.content;
                    noteCard.appendChild(contentEl);

                    // Add Labels
                    if (note.labels && note.labels.length > 0) {
                        const labelsDiv = document.createElement('div');
                        labelsDiv.classList.add('note-labels');
                        note.labels.forEach(label => {
                            const labelSpan = document.createElement('span');
                            labelSpan.classList.add('note-label');
                            // NOVA FUNCIONALIDADE: Marcar etiqueta filtrada
                            if (activeLabelFilter && label === activeLabelFilter) {
                                labelSpan.classList.add('filtered');
                            }
                            labelSpan.textContent = label;
                            labelsDiv.appendChild(labelSpan);
                        });
                        noteCard.appendChild(labelsDiv);
                    }

                    // Add date display (for filtered/searched notes, show their original date)
                    const noteDateDisplayEl = document.createElement('div');
                    noteDateDisplayEl.classList.add('note-date-display');
                    const originalNoteDate = new Date(note.timestamp);
                    noteDateDisplayEl.textContent = `Criado em: ${originalNoteDate.toLocaleDateString('pt-BR')} às ${originalNoteDate.toLocaleTimeString('pt-BR')}`;
                    noteCard.appendChild(noteDateDisplayEl);


                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('note-actions');

                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Editar';
                    // For filtered notes, we need to find the original day and index
                    editBtn.onclick = () => {
                        let originalDayKey = '';
                        let originalIndex = -1;
                        for (const dayKey in notes) {
                            const foundIndex = notes[dayKey].findIndex(n => n.timestamp === note.timestamp && n.title === note.title);
                            if (foundIndex !== -1) {
                                originalDayKey = dayKey;
                                originalIndex = foundIndex;
                                break;
                            }
                        }
                        if (originalDayKey && originalIndex !== -1) {
                            openEditModal(originalDayKey, originalIndex, note);
                        }
                    };
                    actionsDiv.appendChild(editBtn);

                    // Share Button
                    const shareBtn = document.createElement('button');
                    shareBtn.textContent = 'Compartilhar';
                    shareBtn.classList.add('share-btn');
                    shareBtn.onclick = () => {
                        openShareModal(note.title, note.content);
                    };
                    actionsDiv.appendChild(shareBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Apagar';
                    deleteBtn.classList.add('delete-btn');
                    deleteBtn.onclick = () => {
                        let originalDayKey = '';
                        let originalIndex = -1;
                        for (const dayKey in notes) {
                            const foundIndex = notes[dayKey].findIndex(n => n.timestamp === note.timestamp && n.title === note.title);
                            if (foundIndex !== -1) {
                                originalDayKey = dayKey;
                                originalIndex = foundIndex;
                                break;
                            }
                        }
                        if (originalDayKey && originalIndex !== -1) {
                            openConfirmDeleteModal(originalDayKey, originalIndex);
                        }
                    };
                    actionsDiv.appendChild(deleteBtn);

                    noteCard.appendChild(actionsDiv);
                    notesListEl.appendChild(noteCard);
                });
            } else {
                notesListEl.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">Nenhuma anotação para este dia ou que corresponda ao filtro/pesquisa atual.</p>';
            }
        }

        function addNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const labels = document.getElementById('noteLabels').value.split(',').map(label => label.trim()).filter(label => label !== '');
            const reminder = document.getElementById('mainNoteReminderToggle').checked;
            const markerColor = selectedMarkerColor; // Use the globally selected color for the main form


            if (title === '' || content === '') {
                alert('Por favor, preencha o título e o conteúdo da anotação.');
                return;
            }
            if (content.length > MAX_CHARS) {
                alert(`O conteúdo da anotação excede o limite de ${MAX_CHARS} caracteres.`);
                return;
            }

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const fullDateKey = `${selectedDay}-${month + 1}-${year}`;

            if (!notes[fullDateKey]) {
                notes[fullDateKey] = [];
            }
            notes[fullDateKey].push({
                title: title,
                content: content,
                labels: labels,
                timestamp: new Date().toISOString(),
                markerColor: markerColor,
                reminder: reminder
            });
            saveUserData(); // Save notes after adding

            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteLabels').value = '';
            document.getElementById('mainNoteReminderToggle').checked = false;
            selectedMarkerColor = '#6dff6d'; // Reset to default green for next new note
            addMarkerColorPaletteListeners('mainAddNoteMarkerColorPalette'); // Re-select default green
            updateCharCount();


            renderNotes();
            renderCalendar(); // Update calendar to show 'has-notes' indicator
            populateLabelFilter(); // Update filter options after adding a new label
            renderAddNoteArea(); // Re-render to show simplified button if notes now exist
        }

        // NOVA FUNCIONALIDADE: Função para adicionar nova anotação via modal
        function addNewNoteFromModal() {
            const title = newNoteTitleInput.value.trim();
            const content = newNoteContentInput.value.trim();
            const labels = newNoteLabelsInput.value.split(',').map(label => label.trim()).filter(label => label !== '');
            const reminder = newNoteReminderToggle.checked;
            const markerColor = document.querySelector('#newNoteMarkerColorPalette .marker-color-option.selected').dataset.color;

            if (title === '' || content === '') {
                alert('Por favor, preencha o título e o conteúdo da anotação.');
                return;
            }
            if (content.length > MAX_CHARS) {
                alert(`O conteúdo da anotação excede o limite de ${MAX_CHARS} caracteres.`);
                return;
            }

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const fullDateKey = `${selectedDay}-${month + 1}-${year}`;

            if (!notes[fullDateKey]) {
                notes[fullDateKey] = [];
            }
            notes[fullDateKey].push({
                title: title,
                content: content,
                labels: labels,
                timestamp: new Date().toISOString(),
                markerColor: markerColor,
                reminder: reminder
            });
            saveUserData(); // Save notes after adding

            newNoteTitleInput.value = '';
            newNoteContentInput.value = '';
            newNoteLabelsInput.value = '';
            newNoteReminderToggle.checked = false;
            updateModalCharCount('newNoteContent', 'newNoteCharCount');
            closeCreateNoteModal();
            renderNotes();
            renderCalendar();
            populateLabelFilter();
            renderAddNoteArea(); // Re-render to show simplified button
        }

        function deleteNoteConfirmed() {
            if (!noteToDeleteInfo) return;
            const { day, index } = noteToDeleteInfo;

            notes[day].splice(index, 1);
            if (notes[day].length === 0) {
                delete notes[day]; // Remove the day entry if no notes left
            }
            saveUserData(); // Save notes after deleting
            renderNotes();
            renderCalendar(); // Update calendar to remove 'has-notes' indicator if empty
            populateLabelFilter(); // Update filter options after deleting a note
            closeConfirmDeleteModal();
            renderAddNoteArea(); // Re-render to show full form if no notes now
        }

        // --- EDIT MODAL LOGIC ---
        function openEditModal(day, index, note) {
            editingNoteInfo = { day, index };
            editNoteTitleInput.value = note.title;
            editNoteContentInput.value = note.content;
            editNoteLabelsInput.value = (note.labels || []).join(', ');
            editNoteReminderToggle.checked = note.reminder || false;
            updateModalCharCount('editNoteContent', 'editNoteCharCount');

            // CORREÇÃO: Bloquear edição de cor do marcador se não for a primeira anotação do dia
            const fullDateKey = `${currentDate.getDate()}-${currentDate.getMonth() + 1}-${currentDate.getFullYear()}`;
            const isFirstNoteOfDay = notes[day] && notes[day][0] && notes[day][0].timestamp === note.timestamp;

            if (isFirstNoteOfDay) {
                editNoteMarkerColorPalette.classList.remove('disabled');
            } else {
                editNoteMarkerColorPalette.classList.add('disabled');
            }

            setupMarkerColorPalette(editNoteMarkerColorPalette, note.markerColor || '#6dff6d'); // Select existing color
            editModalOverlay.classList.add('active');
            applyMainContentBlur();
        }

        function closeEditModal() {
            editModalOverlay.classList.remove('active');
            removeMainContentBlur();
            editingNoteInfo = null;
        }

        saveEditedNoteBtn.addEventListener('click', () => {
            if (!editingNoteInfo) return;

            const { day, index } = editingNoteInfo;
            const newTitle = editNoteTitleInput.value.trim();
            const newContent = editNoteContentInput.value.trim();
            const newLabels = editNoteLabelsInput.value.split(',').map(label => label.trim()).filter(label => label !== '');
            // Only get new marker color if it's not disabled
            const newMarkerColor = editNoteMarkerColorPalette.classList.contains('disabled') ?
                notes[day][index].markerColor : document.querySelector('#editNoteMarkerColorPalette .marker-color-option.selected').dataset.color;
            const newReminder = editNoteReminderToggle.checked;


            if (newTitle === '' || newContent === '') {
                alert('Título e conteúdo não podem ser vazios.');
                return;
            }
            if (newContent.length > MAX_CHARS) {
                alert(`O conteúdo da anotação excede o limite de ${MAX_CHARS} caracteres.`);
                return;
            }

            notes[day][index].title = newTitle;
            notes[day][index].content = newContent;
            notes[day][index].labels = newLabels;
            notes[day][index].markerColor = newMarkerColor;
            notes[day][index].reminder = newReminder;
            saveUserData(); // Save notes after editing
            renderNotes();
            populateLabelFilter();
            renderCalendar();
            closeEditModal();
        });

        cancelEditBtn.addEventListener('click', closeEditModal);

        // --- CREATE NOTE MODAL LOGIC (NOVA FUNCIONALIDADE) ---
        function openCreateNoteModal() {
            newNoteTitleInput.value = '';
            newNoteLabelsInput.value = '';
            newNoteContentInput.value = '';
            newNoteReminderToggle.checked = false;
            updateModalCharCount('newNoteContent', 'newNoteCharCount');

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const fullDateKey = `${selectedDay}-${month + 1}-${year}`;
            const hasNotesAlready = notes[fullDateKey] && notes[fullDateKey].length > 0;

            if (hasNotesAlready) {
                newNoteMarkerColorPalette.classList.add('disabled');
                // Set the default to the existing marker color of the first note if available
                const existingMarkerColor = notes[fullDateKey][0].markerColor || '#6dff6d';
                setupMarkerColorPalette(newNoteMarkerColorPalette, existingMarkerColor);
            } else {
                newNoteMarkerColorPalette.classList.remove('disabled');
                setupMarkerColorPalette(newNoteMarkerColorPalette, '#6dff6d'); // Reset to default green
            }

            createNoteModalOverlay.classList.add('active');
            applyMainContentBlur();
        }

        function closeCreateNoteModal() {
            createNoteModalOverlay.classList.remove('active');
            removeMainContentBlur();
        }

        saveNewNoteBtn.addEventListener('click', addNewNoteFromModal);
        cancelNewNoteBtn.addEventListener('click', closeCreateNoteModal);

        // --- MARKER COLOR PALETTE LOGIC (NOVA FUNCIONALIDADE) ---
        function setupMarkerColorPalette(paletteElement, currentColor) {
            const colorOptions = paletteElement.querySelectorAll('.marker-color-option');
            colorOptions.forEach(option => {
                option.classList.remove('selected');
                // Remove existing click listeners to prevent duplicates
                option.removeEventListener('click', handleMarkerColorClick);
                if (!paletteElement.classList.contains('disabled')) { // Only add listener if not disabled
                    option.addEventListener('click', handleMarkerColorClick);
                }
            });
            // Select the current color
            const currentSelected = paletteElement.querySelector(`[data-color="${currentColor}"]`);
            if (currentSelected) {
                currentSelected.classList.add('selected');
                // If this is the main add note palette, update global selectedMarkerColor
                if (paletteElement.id === 'mainAddNoteMarkerColorPalette') {
                    selectedMarkerColor = currentColor;
                }
            } else {
                // If current color not found, default to green
                const defaultOption = paletteElement.querySelector('[data-color="#6dff6d"]');
                if (defaultOption) {
                    defaultOption.classList.add('selected');
                    if (paletteElement.id === 'mainAddNoteMarkerColorPalette') {
                        selectedMarkerColor = '#6dff6d';
                    }
                }
            }
        }

        function handleMarkerColorClick(event) {
            const paletteElement = event.target.closest('.marker-color-palette');
            if (!paletteElement || paletteElement.classList.contains('disabled')) return; // Do nothing if palette is disabled

            const colorOptions = paletteElement.querySelectorAll('.marker-color-option');
            colorOptions.forEach(opt => opt.classList.remove('selected'));
            event.target.classList.add('selected');

            // If this is the main add note palette, update global selectedMarkerColor
            if (paletteElement.id === 'mainAddNoteMarkerColorPalette') {
                selectedMarkerColor = event.target.dataset.color;
            }
        }

        // Initial setup for the main add note area (if present on load)
        function addMarkerColorPaletteListeners(paletteId) {
            const palette = document.getElementById(paletteId);
            if (palette) {
                setupMarkerColorPalette(palette, selectedMarkerColor);
            }
        }


        // --- BLUR UTILITIES ---
        function applyMainContentBlur() {
            document.documentElement.style.setProperty('--main-content-blur', 'blur(5px)');
            document.documentElement.style.setProperty('--main-content-pointer-events', 'none');
            document.documentElement.style.setProperty('--main-content-user-select', 'none');
        }

        function removeMainContentBlur() {
            document.documentElement.style.setProperty('--main-content-blur', 'none');
            document.documentElement.style.setProperty('--main-content-pointer-events', 'auto');
            document.documentElement.style.setProperty('--main-content-user-select', 'auto');
        }

        // --- CONFIRM DELETE MODAL LOGIC ---
        function openConfirmDeleteModal(day, index) {
            noteToDeleteInfo = { day, index };
            confirmModalOverlay.classList.add('active');
            applyMainContentBlur();
        }

        function closeConfirmDeleteModal() {
            confirmModalOverlay.classList.remove('active');
            removeMainContentBlur();
            noteToDeleteInfo = null;
        }

        confirmDeleteBtn.addEventListener('click', deleteNoteConfirmed);
        cancelDeleteBtn.addEventListener('click', closeConfirmDeleteModal);

        // --- SHARE MODAL LOGIC ---
        function openShareModal(title, content) {
            noteToShareInfo = { title, content };
            whatsappNumberInput.value = ''; // Clear previous number
            shareModalOverlay.classList.add('active');
            applyMainContentBlur();
        }

        function closeShareModal() {
            shareModalOverlay.classList.remove('active');
            removeMainContentBlur();
            noteToShareInfo = null;
        }

        function shareNoteToWhatsApp() {
            if (!noteToShareInfo) return;

            const phoneNumber = whatsappNumberInput.value.replace(/[^0-9+]/g, ''); // Remove non-numeric chars except '+'
            const { title, content } = noteToShareInfo;
            const message = `*${title}*\n\n${content}`;
            const encodedMessage = encodeURIComponent(message);

            if (!phoneNumber) {
                alert('Por favor, insira um número de WhatsApp.');
                return;
            }

            // Check if it's a mobile device to use native app link
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const whatsappUrl = isMobile
                ? `whatsapp://send?phone=${phoneNumber}&text=${encodedMessage}`
                : `https://web.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`;

            window.open(whatsappUrl, '_blank');
            closeShareModal();
        }

        confirmShareBtn.addEventListener('click', shareNoteToWhatsApp);
        cancelShareBtn.addEventListener('click', closeShareModal);


        // --- LABEL FILTER LOGIC ---
        function populateLabelFilter() {
            const allLabels = new Set();
            for (const dayNotes of Object.values(notes)) {
                dayNotes.forEach(note => {
                    if (note.labels) {
                        note.labels.forEach(label => allLabels.add(label));
                    }
                });
            }

            // Keep the "Filtrar por Etiqueta" as the first option
            labelFilter.innerHTML = '<option value="">Filtrar por Etiqueta</option>';
            Array.from(allLabels).sort().forEach(label => {
                const option = document.createElement('option');
                option.value = label;
                option.textContent = label;
                labelFilter.appendChild(option);
            });

            // Set the active filter value if it exists
            labelFilter.value = activeLabelFilter;
        }

        labelFilter.addEventListener('change', (event) => {
            activeLabelFilter = event.target.value;
            activeSearchQuery = ''; // Clear search when filter is used
            noteSearchInput.value = ''; // Clear search input
            renderNotes(); // Re-render notes with the new filter
            renderCalendar(); // Re-render calendar to show filtered days
        });

        // --- SEARCH BAR LOGIC ---
        noteSearchInput.addEventListener('input', (event) => {
            activeSearchQuery = event.target.value;
            activeLabelFilter = ''; // Clear label filter when search is used
            labelFilter.value = ''; // Clear filter dropdown
            renderNotes(); // Re-render notes with the new search query
            renderCalendar(); // Re-render calendar to remove any previous filter highlights
        });

        // --- AUTO DELETE LOGIC (MODIFIED TO USE PREFERENCES) ---
        function autoDeleteOldNotes() {
            const interval = preferences.autoDeleteInterval || 'never';
            if (interval === 'never') return;

            const now = new Date().getTime(); // Current timestamp in milliseconds
            let threshold = 0;

            switch (interval) {
                case '1_day':
                    threshold = now - (24 * 60 * 60 * 1000); // 1 day ago
                    break;
                case '1_week':
                    threshold = now - (7 * 24 * 60 * 60 * 1000); // 1 week ago
                    break;
                case '1_month':
                    // Approximate 1 month (30 days) for simplicity
                    threshold = now - (30 * 24 * 60 * 60 * 1000); // 1 month ago
                    break;
            }

            let notesChanged = false;
            for (const dayKey in notes) {
                if (notes.hasOwnProperty(dayKey)) {
                    // Filter out notes that are older than the threshold
                    const initialLength = notes[dayKey].length;
                    notes[dayKey] = notes[dayKey].filter(note => {
                        return new Date(note.timestamp).getTime() > threshold;
                    });

                    if (notes[dayKey].length === 0) {
                        delete notes[dayKey]; // Remove day if no notes left
                    }
                    if (notes[dayKey].length !== initialLength) {
                        notesChanged = true;
                    }
                }
            }

            if (notesChanged) {
                saveUserData(); // Save notes after auto-deletion
                renderNotes();
                renderCalendar();
                populateLabelFilter();
            }
        }

        autoDeleteIntervalSelect.addEventListener('change', (event) => {
            preferences.autoDeleteInterval = event.target.value;
            saveUserData(); // Save preference change
            autoDeleteOldNotes(); // Run deletion immediately on change
        });

        // --- REMINDER NOTIFICATION LOGIC (NOVA FUNCIONALIDADE) ---
        function showReminderNotification() {
            const todayKey = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;
            const remindersForToday = (notes[todayKey] || []).filter(note => note.reminder);

            if (remindersForToday.length > 0) {
                reminderNotesList.innerHTML = '';
                remindersForToday.forEach(note => {
                    const reminderItem = document.createElement('div');
                    reminderItem.classList.add('reminder-note-item');
                    reminderItem.innerHTML = `
                        <h4>${note.title}</h4>
                        <p>${note.content}</p>
                    `;
                    reminderNotesList.appendChild(reminderItem);
                });
                reminderNotificationOverlay.classList.add('active');
                applyMainContentBlur();
            }
        }

        function closeReminderNotification() {
            reminderNotificationOverlay.classList.remove('active');
            removeMainContentBlur();
        }

        // --- PRINTING LOGIC (NOVA FUNCIONALIDADE) ---
        function getNotesForPrinting(scope) {
            let notesToPrint = [];
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const day = selectedDay;

            if (scope === 'day') {
                const fullDateKey = `${day}-${month + 1}-${year}`;
                if (notes[fullDateKey]) {
                    notesToPrint = notes[fullDateKey];
                }
            } else if (scope === 'week') {
                const startOfWeek = new Date(year, month, selectedDay);
                startOfWeek.setDate(selectedDay - startOfWeek.getDay()); // Go back to Sunday
                for (let i = 0; i < 7; i++) {
                    const currentPrintDay = new Date(startOfWeek);
                    currentPrintDay.setDate(startOfWeek.getDate() + i);
                    const printDayKey = `${currentPrintDay.getDate()}-${currentPrintDay.getMonth() + 1}-${currentPrintDay.getFullYear()}`;
                    if (notes[printDayKey]) {
                        notesToPrint = notesToPrint.concat(notes[printDayKey]);
                    }
                }
            } else if (scope === 'month') {
                for (let d = 1; d <= new Date(year, month + 1, 0).getDate(); d++) {
                    const printDayKey = `${d}-${month + 1}-${year}`;
                    if (notes[printDayKey]) {
                        notesToPrint = notesToPrint.concat(notes[printDayKey]);
                    }
                }
            }
            return notesToPrint;
        }

        function printNotes(scope, clickedButton) {
            const notesToPrint = getNotesForPrinting(scope);
            printableContent.innerHTML = ''; // Clear previous content

            // Remove selected class from previous print button
            if (lastSelectedPrintOption) {
                lastSelectedPrintOption.classList.remove('selected-print-option');
            }
            // Add selected class to the current clicked button
            if (clickedButton) {
                clickedButton.classList.add('selected-print-option');
                lastSelectedPrintOption = clickedButton;
            }


            if (notesToPrint.length === 0) {
                alert('Nenhuma anotação encontrada para imprimir neste período.');
                return;
            }

            const printTitle = document.createElement('h2');
            let periodText = '';
            if (scope === 'day') {
                periodText = `Anotações do Dia: ${selectedDay} de ${monthNames[currentDate.getMonth()]} de ${currentDate.getFullYear()}`;
            } else if (scope === 'week') {
                const startOfWeek = new Date(currentDate.getFullYear(), currentDate.getMonth(), selectedDay);
                startOfWeek.setDate(selectedDay - startOfWeek.getDay());
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                periodText = `Anotações da Semana: ${startOfWeek.toLocaleDateString('pt-BR')} - ${endOfWeek.toLocaleDateString('pt-BR')}`;
            } else if (scope === 'month') {
                periodText = `Anotações de ${monthNames[currentDate.getMonth()]} de ${currentDate.getFullYear()}`;
            }
            printTitle.textContent = periodText;
            printableContent.appendChild(printTitle);

            // Sort notes by timestamp for consistent printing order
            notesToPrint.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            notesToPrint.forEach(note => {
                const noteCard = document.createElement('div');
                noteCard.classList.add('note-card');

                const originalNoteDate = new Date(note.timestamp);
                const formattedPrintDate = `${originalNoteDate.toLocaleDateString('pt-BR')} às ${originalNoteDate.toLocaleTimeString('pt-BR')}`;

                noteCard.innerHTML = `
                    <h3>${note.title}</h3>
                    <p>${note.content}</p>
                    <div class="note-date-print">Criado em: ${formattedPrintDate}</div>
                `;
                printableContent.appendChild(noteCard);
            });

            // Trigger print
            window.print();
        }

        printDayNotesBtn.addEventListener('click', (event) => printNotes('day', event.target));
        printWeekNotesBtn.addEventListener('click', (event) => printNotes('week', event.target));
        printMonthNotesBtn.addEventListener('click', (event) => printNotes('month', event.target));

        // --- EVENT LISTENERS ---
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            // Ensure selectedDay is valid for the new month
            const daysInNewMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            if (selectedDay > daysInNewMonth) {
                selectedDay = daysInNewMonth;
            }
            activeLabelFilter = ''; // Reset filter when changing month
            labelFilter.value = '';
            activeSearchQuery = ''; // Reset search when changing month
            noteSearchInput.value = '';
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            // Ensure selectedDay is valid for the new month
            const daysInNewMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            if (selectedDay > daysInNewMonth) {
                selectedDay = daysInNewMonth;
            }
            activeLabelFilter = ''; // Reset filter when changing month
            labelFilter.value = '';
            activeSearchQuery = ''; // Reset search when changing month
            noteSearchInput.value = '';
            renderCalendar();
        });

        // addNoteBtn.addEventListener('click', addNote); (Movido para renderAddNoteArea)

        // --- SIDEBAR LOGIC ---
        menuButton.addEventListener('click', () => {
            sidebar.classList.add('open');
            applyMainContentBlur();
        });

        closeSidebar.addEventListener('click', () => {
            sidebar.classList.remove('open');
            removeMainContentBlur();
        });

        // Acordeão: Event Listeners para os cabeçalhos das seções
        sidebarSections.forEach(section => {
            const header = section.querySelector('.sidebar-section-header');
            const content = section.querySelector('.sidebar-section-content');

            header.addEventListener('click', () => {
                // Fechar outras seções se estiverem abertas (comportamento de acordeão)
                sidebarSections.forEach(otherSection => {
                    const otherHeader = otherSection.querySelector('.sidebar-section-header');
                    const otherContent = otherSection.querySelector('.sidebar-section-content');
                    if (otherSection !== section && otherContent.classList.contains('active')) {
                        otherContent.classList.remove('active');
                        otherHeader.classList.remove('active');
                    }
                });

                // Abrir ou fechar a seção clicada
                content.classList.toggle('active');
                header.classList.toggle('active');
            });
        });

        // Event listener for color options inside the new structure
        document.getElementById('colorOptionsContent').addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.color) {
                const newColor = event.target.dataset.color;
                document.documentElement.style.setProperty('--bg-gradient', newColor);
                saveTheme(newColor); // Save the selected theme color

                // Update selected-theme class
                document.querySelectorAll('#colorOptionsContent button').forEach(btn => {
                    btn.classList.remove('selected-theme');
                });
                event.target.classList.add('selected-theme');
            }
        });

        // NEW: Logout functionality
        logoutButton.addEventListener('click', () => {
            sessionStorage.removeItem('currentUser'); // Clear session
            window.location.href = 'Login.html'; // Redirect to login page
        });


        // Initial setup
        // It's crucial to load user data FIRST
        if (loadUserData()) { // Only proceed if user data was loaded successfully (i.e., user is logged in)
            renderCalendar();
            populateLabelFilter(); // Initial population of filter
            autoDeleteOldNotes(); // Run auto-deletion on page load
            // The autoDeleteIntervalSelect.value is already set in loadUserData
            // Check for reminders on page load
            document.addEventListener('DOMContentLoaded', showReminderNotification);
        }
    </script>
</body>

</html>